{% extends 'base.html' %}

{% block content %}
<div class="container">
  <h1 class="mb-4 text-center">🕹️ Últimas publicaciones</h1>

  <!-- Filtros -->
  <form method="get" class="row g-2 mb-4">
    <div class="col-md-3">
      <input type="text" name="q" class="form-control" placeholder="Buscar..." value="{{ request.GET.q }}">
    </div>
    <div class="col-md-3">
      <select name="categoria" class="form-select">
        <option value="">Todas las categorías</option>
        {% for cat in categorias %}
          <option value="{{ cat.id }}" {% if request.GET.categoria == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select name="fecha" class="form-select">
        <option value="">Todas las fechas</option>
        <option value="recientes" {% if request.GET.fecha == 'recientes' %}selected{% endif %}>Más recientes</option>
        <option value="antiguos" {% if request.GET.fecha == 'antiguos' %}selected{% endif %}>Más antiguos</option>
      </select>
    </div>
    <div class="col-md-3">
      <select name="orden" class="form-select">
        <option value="">Ordenar por</option>
        <option value="comentarios" {% if request.GET.orden == 'comentarios' %}selected{% endif %}>Más comentados</option>
        <option value="fecha" {% if request.GET.orden == 'fecha' %}selected{% endif %}>Más recientes</option>
      </select>
    </div>
    <div class="col-12 text-end">
      <button type="submit" class="btn btn-info">Filtrar</button>
    </div>
  </form>

  <!-- Grid de posts -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for post in posts %}
      <div class="col">
        <div class="card h-100 shadow-sm bg-dark text-light border-0">
          {% if post.imagen %}
            <a href="{% url 'detalle_post' post.id %}">
              <img
                src="{{ post.imagen.url }}"
                class="card-img-top img-fluid img-contain"
                style="aspect-ratio:1/1; object-fit:cover;"
                alt="Imagen del post {{ post.titulo }}"
              >
            </a>
          {% endif %}
          <div class="card-body d-flex flex-column">
            <h5 class="card-title u-clamp-2 u-break">
              <a href="{% url 'detalle_post' post.id %}" class="text-light text-decoration-none">
                {{ post.titulo }}
              </a>
            </h5>

            <p class="card-text small mb-2">
              🧑 {{ post.autor.username }}<br>
              📅 {{ post.fecha_creacion|date:"d/m/Y" }}<br>
              📁 {{ post.categoria.nombre|default:"Sin categoría" }}<br>
              💬 {{ post.comentario_set.count }} comentario{{ post.comentario_set.count|pluralize }}
            </p>

            <p class="card-excerpt u-clamp-3 u-break mb-3">
              {{ post.contenido|striptags|truncatechars:150 }}
            </p>

            {% if post.tags.all %}
              <div class="mt-auto">
                <p class="mb-0"><strong>Etiquetas:</strong>
                  {% for tag in post.tags.all %}
                    <a href="{% url 'posts_por_tag' tag.nombre %}" class="badge bg-secondary text-decoration-none me-1">
                      {{ tag.nombre }}
                    </a>
                  {% endfor %}
                </p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12 text-center">
        <p class="text-light fst-italic">🕸️ No se encontraron publicaciones.</p>
      </div>
    {% endfor %}
  </div>

  <!-- Paginación -->
  {% if posts.has_other_pages %}
    <nav class="mt-4">
      <ul class="pagination justify-content-center">
        {% if posts.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ posts.previous_page_number }}">« Anterior</a>
          </li>
        {% endif %}
        {% for i in posts.paginator.page_range %}
          <li class="page-item {% if posts.number == i %}active{% endif %}">
            <a class="page-link" href="?page={{ i }}">{{ i }}</a>
          </li>
        {% endfor %}
        {% if posts.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ posts.next_page_number }}">Siguiente »</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}
